# Experto en Ingeniería Inversa e Inteligencia Malware

## Análisis Dinámico Muestra Sample

Para comenzar el análisis dinámico vimos en el estático que la muestra sample es de 32bits por lo que seleccionamos una máquina con **windows7** *de 32bits* en la que tenemos instaladas las *herramientas necesarias* para realizar el análisis y en la cual ejecutaremos el malware, también usaremos una máquina con **remnux** donde tendrémos corriento **inetsim**.

### Configuración del entorno

Comenzamos por configurar las dos máquinas con una *red* de tipo ***host-only*** en la cual sólo tendrán conexión las máquinas conectadas a esa red para evitar así que el malware pueda pasar al equipo anfitrión o propagarse por la red. No tendrán salida a internet.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/hostonly.JPG)

A continuación comprobamos al conectividad entre ambas máquinas ejecutando el comando ping. Una vez tenemos en red las dos máquinas pasamos a configurar inetsim en la máquina con remnux. Habrá que editar el fichero de configuración para ponerle la ip que tiene Remnux como vemos en la imagen siguiente.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/inetsimconf.JPG)

Acto seguido reiniciamos el servicio. Y comprobamos que está corriendo, por lo que ya tenemos configurado inetsim para responder las peticiones que haga el equipo de windows 7 ordenadas por el malware.

Cambiamos ahora a la máquina con Windows 7 donde vamos a ejecutar el malware y tenemos que preparar las herramientas que vamos a emplear para monitorizar lo que hace el malware en el equipo. Antes de ejecutar la muestra sample, abrimos **Process Explorer** con lo que veremos los procesos que se crean en el sistema cuando ejecutamos el malware, dejaremos a la vista la carpeta donde tenemos la muestra malware y abrimos también **Process Monitor** y paramos y limpiamos la captura para inicializarla justo antes de ejecutar el malware para que no se generen eventos que no necesitamos analizar. La iniciaremos justo antes de ejecutar el malware.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/entorno.JPG)

También vamos a abrir **ApateDNS** que será nuestro servidor dns donde tenemos que poner la ip de la máquina remnux.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/apate.JPG)

Desde el equipo anfitrión vamos a abrir **wireshark** y a ponerlo a capturar paquetes en la red que comparten windows 7 y remnux. Ya que hemos visto en el análisis estático que aparecen algunas direcciones web en las string para confirmar si pueden ser o no relevantes o solo están para despistar.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/wire.JPG)

### Ejecución de la muestra

Al ejecutarlo vemos que en explorer.exe se nos crea un proceso con el nombre de nuestra muestra sample.exe y pocos segundos después se finaliza sample.exe pero aparece un proceso svchost.exe en el mismo explorer.exe en este caso el proceso está enganchado al proceso procexp.exe. Si nos fijamos en la carpeta donde teniamos el malware también ha desaparecido el archivo y process monitor ha ido recogiendo todos los eventos que han ocurrido desde que ejecutamos sample.exe.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/eje1.JPG)


Manejadores del proceso svchost.exe
**\device\afd**

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/man1.JPG) ![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/man2.JPG)

Librerías sospechosas del proceso svchost.exe no nos llama la atención ninguna asi a simple vista 

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/comctl32DLL.JPG)

Con la herramienta ***Autoruns*** podemos ver que se ha creado una nueva clave en el registro con la fecha y hora de hoy aproximadamente de cuando hemos ejecutado la muestra, para ejecutar el archivo que hay en el path **c:\users\practicas\appdata\roaming\jabconf32.exe** al iniciar sesión el usuario. Esto hace que el malware tenga persistencia en el sistema en cada reinicio vuelva a ejecutarse.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/autorun.JPG) 
Si hemos hecho una copia de como estaba el sistema antes de ejecutar el malware y la comparamos con como queda despues de ejecutarlo obtenemos que si, efectivamente ha modificado la clave de registro añadiendo en el userinit que se ejecute el ejecutable jabconf32.exe.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/autorundespues.JPG)

Con esta herramienta (Autoruns) también podemos ver que aparentemente no hay drivers nuevos instalados.

No se ven evidencias de que se hayan instalado nuevos servicios.

En **Gmer** en la opción de files localizamos donde está el archivo pero si vamos a ese sitio en el explorador está oculto.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/jabconf32.JPG)

Comprobamos en el registro de windows la clave que nos aparecía en Autoruns y vemos que modifica en el inicio de sesión para que se ejecute el archivo ***jabconf32.exe***, esto hace que si ese archivo es malicioso se ejecute cada vez que iniciemos windows.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/posiblepersistencia.JPG)

En ApateDNS vemos los dominios a los que intenta conectarse el equipo:
```BASH
www.google.de
earnestnessbiophysicalohax.com
kwtoestnessbiophysycalohax.com
rcvxestnessbiophysycalohax.com
hjbtestnessbiophysycalohax.com
bcmoestnessbiophysycalohax.com
agekestnessbiophysycalohax.com
dbzwestnessbiophysycalohax.com
sgjxestnessbiophysycalohax.com
igjyestnessbiophysycalohax.com
zxahestnessbiophysycalohax.com
zfrpestnessbiophysycalohax.com
hdquestnessbiophysycalohax.com
umcuestnessbiophysycalohax.com
hrbyestnessbiophysycalohax.com
ysrtestnessbiophysycalohax.com
jgteestnessbiophysycalohax.com
hfsnestnessbiophysycalohax.com
njxfestnessbiophysycalohax.com
lpagestnessbiophysycalohax.com
kacuestnessbiophysycalohax.com
xjrgestnessbiophysycalohax.com
wafxestnessbiophysycalohax.com
myjqestnessbiophysycalohax.com
vdwbestnessbiophysycalohax.com
phdxestnessbiophysycalohax.com
ffaoestnessbiophysycalohax.com
miemestnessbiophysycalohax.com
rtneestnessbiophysycalohax.com
omtvestnessbiophysycalohax.com
cmngestnessbiophysycalohax.com
blgjestnessbiophysycalohax.com
dlbhestnessbiophysycalohax.com
dlwaestnessbiophysycalohax.com
weakestnessbiophysycalohax.com
uydzestnessbiophysycalohax.com
muhmestnessbiophysycalohax.com
rrqfestnessbiophysycalohax.com
pjxxestnessbiophysycalohax.com
fjumestnessbiophysycalohax.com
txmoestnessbiophysycalohax.com
```

Usando la herramienta **Vmmap** miramos la estructura de los dos procesos que se crean tras desaparecer el proceso sample.exe.

Comenzando con el ***svchost.exe*** con ***PID 564*** buscamos secciones de código con permisos de escritura, lectura y ejecución. No debe haber secciones con permisos de escritura.

Encontramos dos secciones con permisos ***RXW*** y llama la atención que ***kernel32.dll*** tiene permiso de escritura.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/12.JPG)

El ***svchost.exe*** con ***PID 564*** que se creo tambien a posteriori de la desaparición de sample.exe, tambien contiene dos secciones con esos permisos.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/13.JPG)

Miramos también el proceso padre de estos dos procesos que es ***explorer.exe*** y coindice en las secciones con *RXW* y además de *kernel32.dll* tambien *ntdll.dll* tiene permisos de escritura.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/14.JPG)

Todo esto anterior son indicios de posible **inyección de código**.

También consultamos las strings cargadas en memoria por cada uno de los procesos anteriores y en ambos vemos que aparece la cadena "***This program cannot be run in DOS mode***" y otra cadena en la que se repite "***PADDING***"  lo vemos en los dos procesos *svchost.exe*

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/15.JPG)

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/16.JPG)

Ahora vamos a analizar los eventos que hemos capturado con **Process Monitor**. Buscamos el momento en el que se ejecuta *sample.exe* 

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/gotoevent.JPG)

*********************************************************
Buscamos en el path incluya el nombre del ejecutable que vimos en gmer que se añade al inicio de windows ***jabconf32.exe***.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/21.JPG)

Buscamos los cambios en el registro que vemos relevantes filtrando con RegSetValue.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/19.JPG)
![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/20.JPG)
![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/22.JPG)


CreateFile

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/1.JPG)
![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/2.JPG)
![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/3.JPG)
![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/4.JPG)
![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/5.JPG)
![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/6.JPG)
![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/7.JPG)
![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/8.JPG)
![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/9.JPG)
![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/10.JPG)



Vemos que uno de los procesos Rogue, svchost.exe en la operación CreateFile,vemos el stack y tiene dos funciones **<unknown>** que son sintomas de inyección, son funciones anónimas.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/17.JPG)
![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisDinamico/sample/imagenes/18.JPG)




hash 999ede66d2929411e4e9bde46912b61a