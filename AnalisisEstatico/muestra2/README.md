### Muestra 2:


Para hacer el análisis estático básico vamos a usar una máquina con Remnux y una Windows7 donde tenemos instaladas las herramientas para el análisis. Para este típo de análisis es indiferente usar la versión de 64 o de 32 bits, ya que no vamos a ejecutar el malware, la versión solo es necesaria si las herramientas con las que vamos a analizarlo son para 32 o 64 bits. Partimos de la base de que tenemos una muestra y no sabemos que tipo de fichero es. Tenemos varias herramientas para ver que tipo de muestra es, yo he elegido el comando trid dado que estamos en linux:
- [**trid**](http://mark0.net/soft-trid-e.html): para reconocer el tipo de fichero que es. Es un fichero de windows ejecutable.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra2/trid.JPG)

#### Identificación

- Inicialmente tenemos que saber que **tipo de archivo** es. PE, DLL...
- Su **Hash**

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra2/hash.JPG)

Este hash podemos comprobarlo en webs como virus total para ver si ya existe algun report sobre ese archivo.
![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra2/virustotal.JPG)

El **hash** también podemos usarlo para comparar diferentes muestras, si coinciden que tienen el mismo hash es porque se trata del mismo archivo.
En este caso, solo lo usaré para identificar la muestra.

- El **imphash**: se usa para identificar la familia a la que pertenece el malware. Si al comparar varios archivos vemos que tiene el mismo imphash significa que tiene la misma tabla de importaciones por lo que podemos pensar que son dos muestras parecidas. Esta muestra no es posible sacar su imphash con ninguna de las herramientas que conocemos, con lo cual probablemente signifique que no tiene tabla de importaciones.

- el **ssdeep**: nos ayuda a identificar dos muestras parecidas dando una puntuación en % de similitud entre ambas muestras.

Tanto el imphash como el ssdeep, identifican la familia a la que pertenece la muestra.

Podemos usar Pescanner para obtener el hash, el imphash y el ssdeep, pero en este caso Pescaner no funciona porque no puede darnos el imphash y da un mensaje de error al tratar de sacarlo.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra2/pescanner.JPG)

- Comprobar si es .exe o .dll, si es .exe no esperaremos mucha info en la tabla de exportaciones y si es dll hay información en la tabla de importaciones. Tambien podemos comprobarlo directamente con la herramienta *Pestudio* en la sección file-headers si está habilitado el flag de *executable* o el flag de *dynamic-link-library*. Como vemos en la siguiente captura el fichero que tenemos entre manos es un ejecutable.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra2/ejecutable.JPG) 

#### Extraer indicadores

Para extraer indicadores miraremos las cadenas del fichero, se pueden usar diferentes herramientas. Por ejemplo el comando **strings** en linux, pero ya que tengo abierto **Pestudio** voy a ver las cadenas con esta herramienta.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra2/strings.JPG) 

Aunque para generar un [fichero](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra2/strings-m2.txt) con las strings usare el comando string de la herramienta con el mismo nombre que tengo instalada en remnux.

Las cadenas mas llamativas son las siguientes:
```BASH
!This program cannot be run in DOS mode.
.text
.text
.rdata
.data
.rsrc
0P43
QRPh
A43
4P43
8P43
< P43
@P43
DP43
HP43
LP43
PP43
TP43
XP43
\ P43
` P43
dP43
hP43
lP43
pP43
tP43
xP43
| P43
P43
P43
P43
P43
P43
P43
P43
P43
P43
P43
P43
G9|$Tv99\$Xt3
+43
+43
%0P43
%4P43
%8P43VWS
FEF4634D
FEEBF4E5
FEEB7ED1
9A01A3CC
2475E7D6
81DEF6F6
0B3C57EA
B3D42734
76F86692
6E2C9D91
9D4481D1
5FBF2A0D
B969CD53
C4F28533
CA7F6ECA
450D3C71
272ACDAB
04B1A9BF
078C9E46
018757D9
F9203A75
E1653222
2F5099F8
D30D5866
82476750
DC1B0120
7B5339CD
CC713C44
3E2F6A96
9E867FE8
39F511FB
RSDS
f:\VC5\release\ProtClr.pdb
@43@
4"43O"43Y"43c"43m"43w"43
"43
"43
"43
"43
"43
"43
"43
"43
"43
"43
"43
"43
"43
#43
#43
#43!#43+#435#43?#43I#43S#43]#43g#43q#43
<?xml version='1.0' encoding='UTF-8' standalone='yes'?>
<assembly xmlns='urn:schemas-microsoft-com:asm.v1' manifestVersion='1.0'>
  <trustInfo xmlns="urn:schemas-microsoft-com:asm.v3">
    <security>
      <requestedPrivileges>
        <requestedExecutionLevel level='highestAvailable'/>
      </requestedPrivileges>
    </security>
  </trustInfo>
</assembly>
```

Podemos marcarlas como relevantes porque aparece el mensaje típico de los ficheros PE, el nombre de las secciones, vemos un trozo de código escrito en XML, el 43 se repite mucho, hay un bloque de números en hexadecimal...

Deberíamos buscar lo siguiente, pero lo único que encontramos es lo escrito en el párrafo anterior.

- Indicadores de host:  solo repercuten en la máquina
	- claves de registro
	- rutas de fichero
	- nombres de ficheros
- Indicadores de red:
	- rutas de dominio
	- protocolos que intenta usar para conectarse a un dominio concreto

Para sacar estos indicadores, podemos usar herramientas como **strings**, **floss**, **PEstudio** que además de ver las cadenas nos devuelven los nombres de las librerías.

#### Indicadores PE

Al abrir con la herramienta **CFF Explorer** vemos que no está empaquetado, lo comprobamos en section Headers porque el tamaño de la sección text en disco es igual al tamaño en memoria y si miramos abajo en la parte de UPX no nos da opción a desempaquetar sino solo a empaquetar. 

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra2/cffheaders.JPG) 

- Funciones API: filtrar las que considero por funcionalidad que tienen relación con la funcionalidad sospechosa del malware.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra2/lib.JPG) 

 No aparecen en PEstudio las librerías que usa, pero nos indica que tiene 31 importaciones.

- Busqueda de malformaciones: pueden hacernos sospechar empaquetamiento (tamaño en disco menor que el tamaño en memoria), ver que el entry point está dentro de la secion funciones, exportaciones (en caso de dll). En este malware no observamos indicios de empaquetamiento.  

- Busqueda de llamadas anónimas (funciones de la API sin nombre ni ordinal). 

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra2/anonim.JPG)

En este ejecutable no encontramos ningun nombre de función ni funciones anónimas como podemos ver en la sección Dependency Walker de CFFExplorer. Si usamos PEstudio, podemos ver las importaciones, en las que aparecen los números hexadecimales que encontramos en los strings, lo que nos hace pensar que esos pueden ser los nombres de las funciones que usa el malware.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra2/imports.JPG)

- Recursos: si hay ficheros embebidos, binarios, shelcode, datos cifrados...

Este archivo tiene un único recurso que es el código xml que vimos en las strings.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra2/recursos.JPG)

- Firmas: no contiene firmas.
- Entropia: de secciones y de recursos:

- Secciones en las que no esperamos que aparezca el flag de escritura y sin embargo aparece (seccion .text con flag de escritura)
Hay una cosa sospechosa en el ejecutable, es que la sección texto tiene permisos de ejecución y de escritura cuando realmente solo debería tener permisos de lectura.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra2/permisos.JPG)

Con la herramienta Portex podemos sacar una imágen de colores que muestra gráficamente las secciones que tiene el archivo. 

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra2/muestra2.jpg)

En la columna central podemos ver que practicamente todo es código. En la primera columna nos muestra con colores el tipo de caracteres que contiene y en la última vemos que aparecen las secciones .text .rdata .data .rsrc que contiene recursos, tambien una parte de optional header, como pudimos comprobar con las herramientas CFF explorer y pestudio con anterioridad.


Con este análisis, no hemos conseguido demasiada información sobre el posible malware pero si indicios que nos hacen sospechar que es malicioso como por ejemplo lo de que tenga la sección .text permisos de escritura y lectura, que no aparezcan las funciones ni las librerías que emplea...

