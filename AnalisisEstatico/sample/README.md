# Experto en Ingeniería Inversa e Inteligencia Malware

## Análisis Estático Muestra Sample

La muestra que tenemos entre manos la llamaremos **sample.bin**.

Para hacer el análisis estático básico vamos a usar una máquina con Remnux y una Windows7 donde tenemos instaladas las herramientas para el análisis. Para este típo de análisis es indiferente usar la versión de 64 o de 32 bits, ya que no vamos a ejecutar el malware, la versión solo es necesaria si las herramientas con las que vamos a analizarlo son para 32 o 64 bits. Partimos de la base de que tenemos una muestra y no sabemos que tipo de fichero es. 

#### Identificación

- Inicialmente tenemos que saber que **tipo de archivo** es. PE, DLL...
Tenemos que ver si se trata de un ejecutable o una dll para ello, con *PEstudio* podemos ver que tiene marcado el flag de ejecutable y no el de dll.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/sample/ejecutable.JPG)

- Su **Hash** (es el identificador único de una muestra)

Este hash podemos comprobarlo en webs como virus total para ver si ya existe algun report sobre ese archivo.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/sample/vt.JPG) 

El **hash** también podemos usarlo para comparar diferentes muestras, si coinciden que tienen el mismo hash es porque se trata del mismo archivo.
En este caso, solo lo usaré para identificar la muestra. (md5 en la imagen)

- El **imphash**: se usa para identificar la familia a la que pertenece el malware. Si al comparar varios archivos vemos que tiene el mismo imphash significa que tiene la misma tabla de importaciones por lo que podemos pensar que son dos muestras parecidas.(imphash en la imagen) 

- el **ssdeep**: nos ayuda a identificar dos muestras parecidas dando una puntuación en % de similitud entre ambas muestras. (ssdeep en la imagen)
 
Tanto el imphash como el ssdeep, identifican la familia a la que pertenece la muestra.

Podemos usar Pescanner para obtener el hash, el imphash y el ssdeep:

```BASH
##########################################################################################
[0] File: sample.bin
##########################################################################################

Meta-data
==========================================================================================
Size		: 72800 bytes
Type		: PE32 executable (GUI) Intel 80386, for MS Windows
Architecture	: 32 Bits binary
MD5		: 999ede66d2929411e4e9bde46912b61a
SHA1		: 3bd7d4c728c967a3788569a45a07aa6aac375e44
ssdeep		: 1536:uJJR1jpJYE6JlFLOmD/IyR9LKTiP33/grdgD2txjJnCf3hVANVCvyvkXx:k3Jx6tAeKmvPgrdRjjI/hVANYsk
imphash		: e9ebf10a5d61f1389da4c8c01ae5949b
Date		: 0x51C7DAEF [Mon Jun 24 05:36:47 2013 UTC]
Language	: []
CRC:	(Claimed) : 0x1d882, (Actual): 0x1d97a [SUSPICIOUS]
Entry Point	: 0x401000 .text 0/3
================
Offset | Instructions
----------------------------------------
0	push dword 0x413457
5	call 0x40130e
10	mov ecx,0xa
15	mov esi,esp
17	lea edi,[0x403000]
23	rep movsd 
25	mov eax,[0x403000]
30	dec ecx
31	xor cx,cx
34	shl ecx,0x1
36	and eax,ecx
38	mov esi,eax
40	lea edi,[0x413454]
46	cmpsd 
48	jz 0x401045
50	sub eax,0x10000
55	jmp 0x401026
57	push eax
58	call 0x401314
63	push ebx
64	call 0x401308
69	mov ecx,[eax+0x3c]
72	add ecx,eax
74	cmp word [ecx],0x4550
79	jnz 0x401032
81	push eax
82	call 0x401145
87	call 0x40105c
92	push ebp
93	mov ebp,esp
95	add esp,0xfffffff0
98	xor ebx,ebx

Sections
==========================================================================================
Name       VirtAddr     VirtSize     RawSize    MD5                              Entropy
------------------------------------------------------------------------------------------
.text      0x1000       0x31a        0x400      4c757e9eb6ec531cd2411bab274f476b 5.430209    
.rdata     0x2000       0xcc         0x200      ba4e3742f76641cc34933e570d9b5c6a 1.542637    
.data      0x3000       0x10461      0x10600    37e74fcd4ede4a7718578c8ab8aad240 7.729250    [SUSPICIOUS]

Imports
==========================================================================================
[1] kernel32.dll
	0x402000 CloseHandle
[2] oleaut32.dll
	0x402008 VariantInit
[3] user32.dll
	0x402010 GetDC


```

- Comprobar si es .exe o .dll, si es .exe no esperaremos mucha info en la tabla de exportaciones y si es dll hay información en la tabla de importaciones. Tambien podemos comprobarlo directamente con la herramienta *Pestudio* en la sección file-headers si está habilitado el flag de *executable* o el flag de *dynamic-link-library*. Como vemos en la siguiente captura el fichero que tenemos entre manos es un ejecutable.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/sample/ejecutable.JPG)

#### Extraer indicadores

Para extraer indicadores miraremos las cadenas del fichero, se pueden usar diferentes herramientas. Por ejemplo el comando **strings** en linux, pero ya que tengo abierto **Pestudio** voy a ver las cadenas con esta herramienta. Aunque para generar un [fichero](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/sample/strings-sample.txt) con las strings usare el comando string de la herramienta con el mismo nombre que tengo instalada en remnux.

Las cadenas mas llamativas son las siguientes:
```BASH
!That program cannot be run in DOS mode.
VPRich
.text
`.rdata
@.data
CloseHandle
kernel32.dll
VariantInit
oleaut32.dll
GetDC
user32.dll
[MZ
Adobe Systems1
Adobe Systems1$0
Adobe Systems, Incorporated1
support@adobe.de0
121112000000Z
131111235959Z0
DE1
Adobe Systems1
Adobe Systems1$0
Adobe Systems, Incorporated1
support@adobe.de0
support@adobe.de0
1FN
US1
UT1
Salt Lake City1
The USERTRUST Network1!0
http://www.usertrust.com1
UTN-USERFirst-Object0
100510000000Z
150510235959Z0~1
GB1
Greater Manchester1
Salford1
COMODO CA Limited1$0
COMODO Time Stamping Signer0
;0907
1http://crl.usertrust.com/UTN-USERFirst-Object.crl05
http://ocsp.usertrust.com0
MZX
DE1
Adobe Systems1
Adobe Systems1$0
Adobe Systems, Incorporated1
support@adobe.de
US1
UT1
Salt Lake City1
The USERTRUST Network1!0
http://www.usertrust.com1
UTN-USERFirst-Object
130624130402Z0#
savrg.po
```
Podemos marcarlas como relevantes porque contienen alguna URL o pueden parecer un puerto o bien tienen que ver con dominios, fechas, numeraciones que parezcan relevantes, los nombes de algunas librerías usadas en windows, nos fijariamos si hubiera direcciones ip o algo que pudiera indicarnos que es una ip...

- Indicadores de host:  solo repercuten en la máquina
	- claves de registro, en las strings del fichero no aparecen claves de registro
	- rutas de fichero, no se aprecian rutas de fichero
	- nombres de ficheros, no aparecen nombres de fichero
- Indicadores de red:
	- rutas de dominio, aparecen varios dominios **http://www.usertrust.com1, http://crl.usertrust.com/UTN-USERFirst-Object.crl05, http://ocsp.usertrust.com0** , y un coreo electrónico al parecer de soporte de adobe **support@adobe.de**
	- protocolos que intenta usar para conectarse a un dominio concreto
- También vemos que aparece el nombre de las secciones del ejecutable **.text**, **.rdata** y **.data** y las funciones que importa **CloseHandle**, **VariantInit** y **GetDC** de las librerías que también aparecen sus nombres en las string **kernel32.dll**, **oleaut32.dll** y **user32.dll**. Con estos indicios *podemos sospechar que puede modificar la tabla de manejadores de excepciones para usar las excecpciones en su beneficio*.

#### Indicadores PE

- Funciones API: Las funciones importadas provienen de Kernel32.dll, oleaut32.dll y user32.dll como hemos visto en el parrafo anterior coinciden los nombres de las funciones con las que aparecian en los strings. Lo vemos con PEstudio:

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/sample/imports.JPG)

Las funciones que aparentemente se usan de esas librerías son:
	- **CloseHandle**: se usa para devolver el control despues de usar un manejador de excepciones.
	- **VariantInit**: 
	- **GetDC**: 

- Busqueda de malformaciones: 
Si nos fijamos no hay diferencias significativas entre el tamaño en disco y el tamaño en memoria por lo tanto no parece que esté empaquetado.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/sample/empaq.JPG)

podemos ver que la seccion *.text* es writable y la seccion *data* es executable. Llama la atencion que la sección text tenga el flag de escritura habilitado, es sospechoso.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/sample/writable.JPG) 

- Busqueda de llamadas anónimas (funciones de la API sin nombre ni ordinal)

Con pescanner podemos ver que el CRC también lo señala como sospechoso.

```BASH
CRC:	(Claimed) : 0x1d882, (Actual): 0x1d97a [SUSPICIOUS]
```

- Entropia: de secciones y de recursos:
vemos que tiene una entropia sospechosa en la seccion .data lo vemos con con pscanner. La entropia está por encima de 7 por lo que no aparece la frecuencia normal de un binario ejecutable, por lo que puede que haya algún tipo de encriptación, cifrado o codificado.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/sample/pesc.JPG) 


Con la herramienta Portex podemos sacar una imágen de colores que muestra gráficamente las secciones que tiene el archivo. [Aquí](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/sample/portex-sample.txt) tenemos la salida de texto que nos facilita la herramienta y a continuación tenemos la imagen.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/sample/sample.JPG)




