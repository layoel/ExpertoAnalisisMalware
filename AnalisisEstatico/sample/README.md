# Experto en Ingeniería Inversa e Inteligencia Malware

## Análisis Estático Muestra Sample

La muestra que tenemos entre manos la llamaremos **sample.bin**.

Para hacer el análisis estático básico vamos a usar una máquina con Remnux y una Windows7 donde tenemos instaladas las herramientas para el análisis. Para este típo de análisis es indiferente usar la versión de 64 o de 32 bits, ya que no vamos a ejecutar el malware, la versión solo es necesaria si las herramientas con las que vamos a analizarlo son para 32 o 64 bits. Partimos de la base de que tenemos una muestra y no sabemos que tipo de fichero es. 

#### Identificación

- Inicialmente tenemos que saber que **tipo de archivo** es. PE, DLL...
Tenemos que ver si se trata de un ejecutable o una dll para ello, con *PEstudio* podemos ver que tiene marcado el flag de ejecutable y no el de dll.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/sample/ejecutable.JPG)

- Su **Hash** (es el identificador único de una muestra)

Este hash podemos comprobarlo en webs como virus total para ver si ya existe algun report sobre ese archivo.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/sample/VT.JPG) ///////////FALTA IMAGEN VT

El **hash** también podemos usarlo para comparar diferentes muestras, si coinciden que tienen el mismo hash es porque se trata del mismo archivo.
En este caso, solo lo usaré para identificar la muestra. (md5 en la imagen)

- El **imphash**: se usa para identificar la familia a la que pertenece el malware. Si al comparar varios archivos vemos que tiene el mismo imphash significa que tiene la misma tabla de importaciones por lo que podemos pensar que son dos muestras parecidas.(imphash en la imagen) 

- el **ssdeep**: nos ayuda a identificar dos muestras parecidas dando una puntuación en % de similitud entre ambas muestras. (ssdeep en la imagen)
 
Tanto el imphash como el ssdeep, identifican la familia a la que pertenece la muestra.

Podemos usar Pescanner para obtener el hash, el imphash y el ssdeep:

```BASH
*******************************************pescan-sample.txt
```

- Comprobar si es .exe o .dll, si es .exe no esperaremos mucha info en la tabla de exportaciones y si es dll hay información en la tabla de importaciones. Tambien podemos comprobarlo directamente con la herramienta *Pestudio* en la sección file-headers si está habilitado el flag de *executable* o el flag de *dynamic-link-library*. Como vemos en la siguiente captura el fichero que tenemos entre manos es un ejecutable.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/sample/ejecutable.JPG)

#### Extraer indicadores

Para extraer indicadores miraremos las cadenas del fichero, se pueden usar diferentes herramientas. Por ejemplo el comando **strings** en linux, pero ya que tengo abierto **Pestudio** voy a ver las cadenas con esta herramienta. Aunque para generar un [fichero](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/sample/strings-sample.txt) con las strings usare el comando string de la herramienta con el mismo nombre que tengo instalada en remnux.

Las cadenas mas llamativas son las siguientes:
```BASH
!That program cannot be run in DOS mode.
VPRich
.text
`.rdata
@.data
CloseHandle
kernel32.dll
VariantInit
oleaut32.dll
GetDC
user32.dll
[MZ
Adobe Systems1
Adobe Systems1$0
Adobe Systems, Incorporated1
support@adobe.de0
121112000000Z
131111235959Z0
DE1
Adobe Systems1
Adobe Systems1$0
Adobe Systems, Incorporated1
support@adobe.de0
support@adobe.de0
1FN
US1
UT1
Salt Lake City1
The USERTRUST Network1!0
http://www.usertrust.com1
UTN-USERFirst-Object0
100510000000Z
150510235959Z0~1
GB1
Greater Manchester1
Salford1
COMODO CA Limited1$0
COMODO Time Stamping Signer0
;0907
1http://crl.usertrust.com/UTN-USERFirst-Object.crl05
http://ocsp.usertrust.com0
MZX
DE1
Adobe Systems1
Adobe Systems1$0
Adobe Systems, Incorporated1
support@adobe.de
US1
UT1
Salt Lake City1
The USERTRUST Network1!0
http://www.usertrust.com1
UTN-USERFirst-Object
130624130402Z0#
savrg.po
```
Podemos marcarlas como relevantes porque contienen alguna URL o pueden parecer un puerto o bien tienen que ver con dominios, fechas, numeraciones que parezcan relevantes, los nombes de algunas librerías usadas en windows, nos fijariamos si hubiera direcciones ip o algo que pudiera indicarnos que es una ip...

- Indicadores de host:  solo repercuten en la máquina
	- claves de registro, en las strings del fichero no aparecen claves de registro
	- rutas de fichero, no se aprecian rutas de fichero
	- nombres de ficheros, no aparecen nombres de fichero
- Indicadores de red:
	- rutas de dominio, aparecen varios dominios **http://www.usertrust.com1, http://crl.usertrust.com/UTN-USERFirst-Object.crl05, http://ocsp.usertrust.com0** , y un coreo electrónico al parecer de soporte de adobe **support@adobe.de**
	- protocolos que intenta usar para conectarse a un dominio concreto
- También vemos que aparece el nombre de las secciones del ejecutable **.text**, **.rdata** y **.data** y las funciones que importa **CloseHandle**, **VariantInit** y **GetDC** de las librerías que también aparecen sus nombres en las string **kernel32.dll**, **oleaut32.dll** y **user32.dll**. Con estos indicios *podemos sospechar que puede modificar la tabla de manejadores de excepciones para usar las excecpciones en su beneficio*.

#### Indicadores PE

- Funciones API: Las funciones importadas provienen de Kernel32.dll, oleaut32.dll y user32.dll como hemos visto en el parrafo anterior coinciden los nombres de las funciones con las que aparecian en los strings. Lo vemos con PEstudio:

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/sample/imports.JPG)

Las funciones que aparentemente se usan de esas librerías son:
	- **CloseHandle**: se usa para devolver el control despues de usar un manejador de excepciones.
	- **VariantInit**: 
	- **GetDC**: 

- Busqueda de malformaciones: 
Si nos fijamos no hay diferencias significativas entre el tamaño en disco y el tamaño en memoria por lo tanto no parece que esté empaquetado.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/sample/empaq.JPG)

podemos ver que la seccion *.text* es writable y la seccion *data* es executable. Llama la atencion que la sección text tenga el flag de escritura habilitado, es sospechoso.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/sample/writable.JPG) 

- Busqueda de llamadas anónimas (funciones de la API sin nombre ni ordinal)

Con pescanner podemos ver que el CRC también lo señala como sospechoso.

```BASH
CRC:	(Claimed) : 0x1d882, (Actual): 0x1d97a [SUSPICIOUS]
```

- Entropia: de secciones y de recursos:
vemos que tiene una entropia sospechosa en la seccion .data lo vemos con con pscanner. La entropia está por encima de 7 por lo que no aparece la frecuencia normal de un binario ejecutable, por lo que puede que haya algún tipo de encriptación, cifrado o codificado.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/sample/pesc.JPG) 


Con la herramienta Portex podemos sacar una imágen de colores que muestra gráficamente las secciones que tiene el archivo. [Aquí](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/sample/portex-sample.txt) tenemos la salida de texto que nos facilita la herramienta y a continuación tenemos la imagen.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/sample/sample.JPG)





//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

Análisis a nivel de aplicación: 
Realizar un análisis estático del fichero, anotando toda la información relevante y ejecuta posteriormente la muestra empleando las herramientas destacadas durante la Unidad 4. Durante el análisis dinámico las conjeturas realizadas deben quedar claras. 

Análisis a nivel de código: 

El objetivo mínimo que se pide en la parte de código es detectar dónde se esconde la carga maliciosa y de qué manera se lleva a cabo la ejecución

Diseño de una regla(s) Yara:

 que recoga los IoCs más importantes de todo el análisis realizado en los pasos anteriores.
Se trata de demostrar que has entendido la teoría y sabes aplicar lo aprendido durante las sesiones prácticas. Eso es lo que debe reflejar el trabajo que desarrolles.


La entrega consiste en tres ficheros:

Un fichero PDF en el que documentes los aspectos más relevantes del análisis que hayas descubierto. Deberás presentar capturas de pantallas o registros del log de las distintas evidencias capturadas durante el análisis estático y dinámico. Si además quieres adjuntar ficheros de análisis o logs, entonces entrega un fichero ZIP conteniendo todos estos ficheros y el documento PDF.

Un fichero .i64 con las anotaciones realizadas mediante IDA Free 7.
Un fichero de texto que contenga la regla(s) escritas para la detección de la muestra analizada y/o posibles variaciones de la misma.