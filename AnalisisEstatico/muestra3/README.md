### Muestra 3:


Para hacer el análisis estático básico vamos a usar una máquina con Remnux y una Windows7 donde tenemos instaladas las herramientas para el análisis. Para este típo de análisis es indiferente usar la versión de 64 o de 32 bits, ya que no vamos a ejecutar el malware, la versión solo es necesaria si las herramientas con las que vamos a analizarlo son para 32 o 64 bits. Partimos de la base de que tenemos una muestra y no sabemos que tipo de fichero es. Tenemos varias herramientas para ver que tipo de muestra es, yo he elegido el comando trid dado que estamos en linux:
- [**trid**](http://mark0.net/soft-trid-e.html): para reconocer el tipo de fichero que es. Es un fichero de windows ejecutable comprimido.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/trid.JPG)

#### Identificación

- Inicialmente tenemos que saber que **tipo de archivo** es. PE, DLL...
- Su **Hash**

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/hash.JPG)

Este hash podemos comprobarlo en webs como virus total para ver si ya existe algun report sobre ese archivo.
![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/virustotal.JPG)

El **hash** también podemos usarlo para comparar diferentes muestras, si coinciden que tienen el mismo hash es porque se trata del mismo archivo.
En este caso, solo lo usaré para identificar la muestra.

- El **imphash**: se usa para identificar la familia a la que pertenece el malware. Si al comparar varios archivos vemos que tiene el mismo imphash significa que tiene la misma tabla de importaciones por lo que podemos pensar que son dos muestras parecidas.

- el **ssdeep**: nos ayuda a identificar dos muestras parecidas dando una puntuación en % de similitud entre ambas muestras.

Tanto el imphash como el ssdeep, identifican la familia a la que pertenece la muestra.

Podemos usar Pescanner para obtener el hash, el imphash y el ssdeep:

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/pescanner.JPG)

Aqui podemos ver la salida de pescanner:
```BASH
##########################################################################################
[0] File: muestra6.bin
##########################################################################################

Meta-data
==========================================================================================
Size		: 152656 bytes
Type		: PE32 executable (GUI) Intel 80386, for MS Windows, UPX compressed
Architecture	: 32 Bits binary
MD5		: 50ea80fd625cfbb549d4cfd60056268a
SHA1		: 4b47c556bad63ccfd52c79c6b9ac577cbbd6c487
ssdeep		: 3072:Ds2AScnUbT3dis6SLlDLAS9fVKsXJY1vz79/btY1GuAG0nXxw/wouh7U:Ds2ASbbTNifSLlltVZY1b79/BmX0nXxq
imphash		: 5b964744f50664bfd44fa1f37388c15e
Date		: 0x4D690214 [Sat Feb 26 13:37:24 2011 UTC]
Language	: ENGLISH
CRC:	(Claimed) : 0x2f3d0, (Actual): 0x321b1 [SUSPICIOUS]
Packers		: UPX 2.93 - 3.00 [LZMA] -> Markus Oberhumer, Laszlo Molnar & John Reiser
Entry Point	: 0x44bf30 UPX1 1/3 [SUSPICIOUS]
================
Offset | Instructions
----------------------------------------
0	pusha 
1	mov esi,0x429000
6	lea edi,[esi-0x28000]
12	push edi
13	mov ebp,esp
15	lea ebx,[esp-0x3e80]
22	xor eax,eax
24	push eax
25	cmp esp,ebx
27	jnz 0x44bf48
29	inc esi
30	inc esi
31	push ebx
32	push dword 0x4987d
37	push edi
38	add ebx,0x4
41	push ebx
42	push dword 0x22f28
47	push esi
48	add ebx,0x4
51	push ebx
52	push eax
53	mov dword [ebx],0x20003
59	nop 
60	nop 
61	nop 
62	nop 
63	nop 
64	push ebp
65	push edi
66	push esi
67	push ebx
68	sub esp,0x7c
71	mov edx,[esp+0x90]
78	mov dword [esp+0x74],0x0
86	mov byte [esp+0x73],0x0
91	mov ebp,[esp+0x9c]
98	lea eax,[edx+0x0]

Version info
==========================================================================================
InternalName	: Offend Sin Baron
FileDescription	: Tee Gaily Bonn
FileVersion	: 8.3
CompanyName	: StarNet Communications Corp.
Translation	: 0x0409 0x04b0

Signature scans
==========================================================================================

Clamav: LibClamAV Warning: **************************************************

Sections
==========================================================================================
Name       VirtAddr     VirtSize     RawSize    MD5                              Entropy
------------------------------------------------------------------------------------------
UPX0       0x1000       0x28000      0x0        d41d8cd98f00b204e9800998ecf8427e 0.000000    [SUSPICIOUS]
UPX1       0x29000      0x24000      0x23c00    40e4a083afd0a108db396748425059d8 7.994674    [SUSPICIOUS]
.rsrc      0x4d000      0x1000       0x600      7ce5dcf721a771522543ca147671b0d3 2.678819    

Resource entries
==========================================================================================
Resource type      Total   
-------------------------
RT_STRING          : 2       
RT_BITMAP          : 1       
RT_MENU            : 1       
RT_DIALOG          : 1       
RT_VERSION         : 1       
------------------------------------------------------------------------------------------
Name               RVA      Size     Lang         Sublang                  Type
------------------------------------------------------------------------------------------
RT_BITMAP          0x481a8  0x528    LANG_ENGLISH SUBLANG_ENGLISH_US       data
RT_MENU            0x486d0  0x11     LANG_ENGLISH SUBLANG_ENGLISH_US       data
RT_DIALOG          0x486e4  0xafe    LANG_ENGLISH SUBLANG_ENGLISH_US       data
RT_STRING          0x491e4  0x2e     LANG_ENGLISH SUBLANG_ENGLISH_US       data
RT_STRING          0x49214  0x2e     LANG_ENGLISH SUBLANG_ENGLISH_US       data
RT_VERSION         0x4d1ac  0x1ec    LANG_ENGLISH SUBLANG_ENGLISH_US       data

Imports
==========================================================================================
[1] KERNEL32.DLL
	0x44d3e8 LoadLibraryA
	0x44d3ec GetProcAddress
	0x44d3f0 VirtualProtect
	0x44d3f4 VirtualAlloc
	0x44d3f8 VirtualFree
	0x44d3fc ExitProcess
[2] advapi32.dll
	0x44d404 CloseTrace
[3] user32.dll
	0x44d40c ToAscii

Suspicious IAT alerts
==========================================================================================
[1] GetProcAddress
[2] LoadLibraryA
[3] VirtualAlloc
[4] VirtualProtect


```

También podemos usar la herramienta portex, con la cual obtenemos un reporte completo:
```BASH
PortEx Analyzer

Report For muestra6.bin
***********************

file size 0x25450
full path /home/remnux/Desktop/lab/malware/pe/muestra6/muestra6.bin

Section Table
*************
                         1. UPX0         2. UPX1         3. .rsrc       
-------------------------------------------------------------------------
Entropy                  0.00            7.99            2.68           
Pointer To Raw Data      0x400           0x400           0x24000        
Size Of Raw Data         0x0             0x23c00         0x600          
Physical End             0x400           0x24000         0x24600        
Virtual Address          0x1000          0x29000         0x4d000        
Virtual Size             0x28000         0x24000         0x1000         
Pointer To Relocations   0x0             0x0             0x0            
Number Of Relocations    0x0             0x0             0x0            
Pointer To Line Numbers  0x0             0x0             0x0            
Number Of Line Numbers   0x0             0x0             0x0            
Initialized Data                         x               x              
Uninitialized Data       x                                              
Execute                  x               x                              
Read                     x               x               x              
Write                    x               x               x              

MSDOS Header
************

description                            value          file offset    
---------------------------------------------------------------------
signature word                         0x5a4d         0x0            
last page size                         0x90           0x2            
file pages                             0x3            0x4            
relocation items                       0x0            0x6            
header paragraphs                      0x4            0x8            
minimum number of paragraphs allocated 0x0            0xa            
maximum number of paragraphs allocated 0xffff         0xc            
initial SS value                       0x0            0xe            
initial SP value                       0xb8           0x10           
complemented checksum                  0x0            0x12           
initial IP value                       0x0            0x14           
pre-relocated initial CS value         0x0            0x16           
relocation table offset                0x40           0x18           
overlay number                         0x0            0x1a           
Reserved word 0x1c                     0x0            0x1c           
Reserved word 0x1e                     0x0            0x1e           
Reserved word 0x20                     0x0            0x20           
Reserved word 0x22                     0x0            0x22           
OEM identifier                         0x0            0x24           
OEM information                        0x0            0x26           
Reserved word 0x28                     0x0            0x28           
Reserved word 0x2a                     0x0            0x2a           
Reserved word 0x2c                     0x0            0x2c           
Reserved word 0x2f                     0x0            0x2e           
Reserved word 0x30                     0x0            0x30           
Reserved word 0x32                     0x0            0x32           
Reserved word 0x34                     0x0            0x34           
Reserved word 0x36                     0x0            0x36           
Reserved word 0x38                     0x0            0x38           
Reserved word 0x3a                     0x0            0x3a           
PE signature offset                    0xe0           0x3c           

COFF File Header
****************

time date stamp  Feb 26, 2011 2:37:24 PM
machine type     Intel 386 or later processors and compatible processors
characteristics  * Image only, Windows CE, and Windows NT and later.
                 * Image only.
                 * COFF line numbers have been removed. DEPRECATED
                 * COFF symbol table entries for local symbols have been removed. DEPRECATED
                 * Machine is based on a 32-bit-word architecture.

description                          value          file offset    
-------------------------------------------------------------------
machine type                         0x14c          0xe4           
number of sections                   0x3            0xe6           
time date stamp                      0x4d690214     0xe8           
pointer to symbol table (deprecated) 0x0            0xec           
number of symbols (deprecated)       0x0            0xf0           
size of optional header              0xe0           0xf4           
characteristics                      0x10f          0xf6           

Optional Header
***************

Magic Number: PE32, normal executable file
Entry Point is in section 2 with name UPX1
No DLL Characteristics
Subsystem:           The Windows graphical user interface (GUI) subsystem

standard field                       value            file offset      
-----------------------------------------------------------------------
magic number                         0x10b            0xf8             
major linker version                 0x6              0xfa             
minor linker version                 0x0              0xfb             
size of code                         0x24000          0xfc             
size of initialized data             0x1000           0x100            
size of unitialized data             0x28000          0x104            
address of entry point               0x4bf30          0x108            
address of base of code              0x29000          0x10c            
address of base of data              0x4d000          0x110            

windows field                        value            file offset      
-----------------------------------------------------------------------
image base                           0x400000         0x114            
section alignment in bytes           0x1000           0x118            
file alignment in bytes              0x200            0x11c            
major operating system version       0x6              0x120            
minor operating system version       0x4              0x122            
major image version                  0xa              0x124            
minor image version                  0x3              0x126            
major subsystem version              0x4              0x128            
minor subsystem version              0x0              0x12a            
win32 version value (reserved)       0x0              0x12c            
size of image in bytes               0x4e000          0x130            
size of headers                      0x1000           0x134            
checksum                             0x2f3d0          0x138            
subsystem                            0x2              0x13c            
dll characteristics                  0x0              0x13e            
size of stack reserve                0x100000         0x140            
size of stack commit                 0x1000           0x144            
size of heap reserve                 0x100000         0x148            
size of heap commit                  0x1000           0x14c            
loader flags (reserved)              0x0              0x150            
number of rva and sizes              0x10             0x154            

data directory          rva              -> offset        size             in section       file offset      
-------------------------------------------------------------------------------------------------------------
import table            0x4d398          0x24398          0x110            3 .rsrc          0x160            
resource table          0x4d000          0x24000          0x398            3 .rsrc          0x168            
certificate table       0x24800          0x23c00          0xc50            1 UPX0           0x178            

Imports
*******

KERNEL32.DLL
------------
[Memory Management] <Virtual Memory>
rva: 0x4d3f0, va: 0x44d3e8, hint: 0, name: VirtualProtect -> Changes the access protection on a region of committed pages in the virtual address space of the calling process.
rva: 0x4d3f4, va: 0x44d3e8, hint: 0, name: VirtualAlloc -> Reserves or commits a region of pages in the virtual address space of the calling process.
rva: 0x4d3f8, va: 0x44d3e8, hint: 0, name: VirtualFree -> Releases or decommits a region of pages within the virtual address space of the calling process.

[Dynamic-Link Library] 
rva: 0x4d3e8, va: 0x44d3e8, hint: 0, name: LoadLibraryA -> Maps the specified executable module into the address space of the calling process.
rva: 0x4d3ec, va: 0x44d3e8, hint: 0, name: GetProcAddress -> Retrieves the address of an exported function or variable from the specified DLL.

[Process and Thread] <Process>
rva: 0x4d3fc, va: 0x44d3e8, hint: 0, name: ExitProcess -> Ends the calling process and all its threads.


advapi32.dll
------------
[Other]
rva: 0x4d404, va: 0x44d404, hint: 0, name: CloseTrace


user32.dll
----------
[Keyboard Input] 
rva: 0x4d40c, va: 0x44d40c, hint: 0, name: ToAscii -> no description


Resources
*********

offset: 0x1f5a8, size: 0x528, language -> ID: 1033, name -> ID: 3, type -> ID: RT_BITMAP
offset: 0x1fad0, size: 0x11, language -> ID: 1033, name -> ID: 1, type -> ID: RT_MENU
offset: 0x1fae4, size: 0xafe, language -> ID: 1033, name -> ID: 5, type -> ID: RT_DIALOG
offset: 0x205e4, size: 0x2e, language -> ID: 1033, name -> ID: 4, type -> ID: RT_STRING
offset: 0x20614, size: 0x2e, language -> ID: 1033, name -> ID: 6, type -> ID: RT_STRING
offset: 0x241ac, size: 0x1ec, language -> ID: 1033, name -> ID: 1, type -> ID: RT_VERSION


Version Information
*******************

VS_FIXEDFILEINFO
----------------
signature: 0xfeef04bd
binary version:  1.0
file version: 524291.0
product version: 524291.0
file flags mask: 0x3f
file flags: 0x0
file OS: Windows NT, 32-bit Windows
file type: application
file subtype: 0
file date: 0.0

StringFileInfo
---------------
language ID: 0x0409
code page: 0x04B0
CompanyName: StarNet Communications Corp. 
FileDescription: Tee Gaily Bonn 
FileVersion: 8.3 
InternalName: Offend Sin Baron 

Overlay
*******

Overlay at offset 0x24600
Overlay size      0xe50

Signatures: 
none

Anomalies
*********

* Deprecated Characteristic in COFF File Header: IMAGE_FILE_LINE_NUMS_STRIPPED
* Deprecated Characteristic in COFF File Header: IMAGE_FILE_LOCAL_SYMS_STRIPPED
* Optional Header: Size of Headers should be 1024, but is 0x1000
* Optional Header: size of code is too large (0x24000), it should be 0x0
* Optional Header: size of initialized data is too small (0x1000), it should be 0x24200
* Optional Header: size of uninitialized data is too large (0x28000), it should be 0x0
* Section Header 1 with name UPX0: POINTER_TO_RAW_DATA must be 0 for sections with only uninitialized data, but is: 1024
* Section Header 1 with name UPX0: SIZE_OF_RAW_DATA is 0
* Section name UPX0 is typical for UPX packer
* Section name UPX1 is typical for UPX packer
* Section 1 with name UPX0 (range: 1024--1024) physically overlaps with section UPX1 with number 2 (range: 1024--147456)
* Section 1 with name UPX0 has write and execute characteristics.
* Section 2 with name UPX1 has write and execute characteristics.
* Entry point is in writeable section 2 with name UPX1
* Section Header 3 with name .rsrc has unusual characteristics, that shouldn't be there: Write
* Resources are fractionated!

PEID Signatures
***************

[UPX 2.93 - 3.00 [LZMA] -> Markus Oberhumer, Laszlo Molnar & John Reiser] bytes matched: 44 at address: 0x23330
pattern:  60 be ?? ?? ?? ?? 8d be ?? ?? ?? ?? 57 89 e5 8d 9c 24 ?? ?? ?? ?? 31 c0 50 39 dc 75 fb 46 46 53 68 ?? ?? ?? ?? 57 83 c3 04 53 68 ?? ?? ?? ?? 56 83 c3 04 53 50 c7 03 03 00 02 00 90 90 90 90 90
[UPX v1.25 (Delphi) Stub] bytes matched: 8 at address: 0x23330
pattern:  60 be 00 ?? ?? 00 8d be 00 ?? ?? ff

Hashes
******

MD5:    50ea80fd625cfbb549d4cfd60056268a
SHA256: 63de57e12e6f79486ad7c65aa44fb7cbcd0bf72011ca11d0ae78a2219db3a518

Section      Type      Hash Value                                                      
---------------------------------------------------------------------------------------
1. UPX0      MD5                                                                       
             SHA256                                                                    
2. UPX1      MD5       40e4a083afd0a108db396748425059d8                                
             SHA256    f11f5637631946a5e90ae8135e703f9ba605a257bbd800fb8ee737ed48405b22
3. .rsrc     MD5       7ce5dcf721a771522543ca147671b0d3                                
             SHA256    c661daec7867cbbb272843de076fbd2fe33f5e6f9aa9dd8dc5d6aabdd2f99eda

--- end of report ---

creating visualization...
picture successfully created and saved to /home/remnux/Desktop/lab/malware/pe/muestra6.jpg

```

- Comprobar si es .exe o .dll, si es .exe no esperaremos mucha info en la tabla de exportaciones y si es dll hay información en la tabla de importaciones. Tambien podemos comprobarlo directamente con la herramienta *Pestudio* en la sección file-headers si está habilitado el flag de *executable* o el flag de *dynamic-link-library*. Como vemos en la siguiente captura el fichero que tenemos entre manos es un ejecutable.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/Pestudio-m6-exe.JPG) 

#### Extraer indicadores

Para extraer indicadores miraremos las cadenas del fichero, se pueden usar diferentes herramientas. Por ejemplo el comando **strings** en linux, pero ya que tengo abierto **Pestudio** voy a ver las cadenas con esta herramienta. Aunque para generar un [fichero](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/strings-m6.txt) con las strings usare el comando string de la herramienta con el mismo nombre que tengo instalada en remnux.

Las cadenas mas llamativas son las siguientes:
```BASH
!This program cannot be run in DOS mode.
UPX0
UPX1
.rsrc
UPX!
Kernel32.DLL
advapi32.dll
user32.dll
LoadLibraryA
GetProcAddress
VirtualProtect
VirtualAlloc
VirtualFree
ExiProcess
CloseTrace
ToAscii
EM::
%P/>vh%
Pv=@S?%wSZ
Root Agency0
Root Agency
VeriSign, Inc.1+0)
"VeriSign Time Stamping Services CA0
+VeriSign Time Stamping Services Signer - G20
JcEG.k
"http://ocsp.verisign.com0
"http://crl.verisign.com/tss-ca.cl0
TSA1-20
Western Cape1
Durbanville1
Thawte1
Thawte Certification1
Thawte Timestamping CA0
031204000000Z
131203235959Z0S1
VerySign, Inc.1+0)
"VeriSign Time Stamping Services CA0
http://ocsp.verisign.com0
:0806
0http://clr.verisign.com/ThawteTimestampingCA.crl0
TRA2048-1-530
Root Agency
```

Podemos marcarlas como relevantes porque contienen alguna URL o pueden parecer un puerto o bien tienen que ver con dominios, fechas, numeraciones que parezcan relevantes, los nombes de algunas librerías usadas en windows, al inicio vemos que aparecen UPX0 y UPX1 que pueden ser signos de compresión con ese formato. Nos fijariamos si hubiera direcciones ip o algo que pudiera indicarnos que es una ip...

- Indicadores de host:  solo repercuten en la máquina
	- claves de registro
	- rutas de fichero
	- nombres de ficheros
- Indicadores de red:
	- rutas de dominio
	- protocolos que intenta usar para conectarse a un dominio concreto

Para sacar estos indicadores, podemos usar herramientas como **strings**, **floss**, **PEstudio** que además de ver las cadenas nos devuelven los nombres de las librerías.

#### Indicadores PE

Al abrir con la herramienta **CFF Explorer** vemos que realmente si que está empaquetado. En la sección Data Headers nos aparecen 3 cabeceras *UPX0 UPX1* y *.rsrc*

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/cffheaders.JPG) 

Lo desempaquetamos:
Ya vemos que en Section Headers aparecen más secciones:

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/cffheaders2.JPG) 

- Funciones API: filtrar las que considero por funcionalidad que tienen relación con la funcionalidad sospechosa del malware. Marcar y comentar en una linera.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/lib.JPG) 

 Las librerías que aparecen son:
 Kernel32.dll - Librería que gestiona los procesos principales del Sistema, gestiona la memoria, los puertos de entrada salida.
 advapi32.dll - 
 user32.dll

- Busqueda de malformaciones: pueden hacernos sospechar empaquetamiento (tamaño en disco menor que el tamaño en memoria), ver que el entri point está dentro de la secion funciones, exportaciones (en caso de dll),  
- Busqueda de llamadas anónimas (funciones de la API sin nombre ni ordinal)

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/anonim.JPG)

Como vemos en la imagen no aparecen llamadas anónimas. 
- Recursos: si hay ficheros embebidos, binarios, shelcode, datos cifrados...

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/recursos.JPG)

Los recursos de este archivo no parecen importantes como para tenerlos en cuenta.

- Firmas: abrir con hexadecimal y ver codigo binario parsear pkcs7 me llevo la info y lo parseo con un parseador pkcs7 y ver si sobre información...
- Entropia: de secciones y de recursos:
Nos fijamos en el % de tamaño de seccion y de recurso con respecto a la totalidad del fichero. PEstudio lo hace. si un recurso tiene un 94% del fichero sospecharemos que el resto del ejecutable desempaqueta y ejecuta ese recurso.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/disco-mem.JPG)

En la imagen anterior vemos las diferencias de tamaño en disco y en memoria, otra evidencia más de que está empaquetado y que el ejecutable lo que hace es desempaquetar.

- Secciones en las que no esperamos que aparezca el flag de escritura y sin embargo aparece (seccion .text con flag de escritura)
En PEstudio en Sections vemos que la secciones UPX0 y UPX1 tiene permisos de extritura y de ejecución, eso es sospechoso.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/flagsrwx.JPG)

Con la herramienta Portex podemos sacar una imágen de colores que muestra gráficamente las secciones que tiene el archivo. 

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/muestra6.jpg)

En la columna central podemos ver que predomina el color aguamarina que es otro indicador más de que está empaquetado. En la primera columna nos muestra con colores el tipo de caracteres que contiene y en la última vemos que solo aparecen las secciones UPX0 UPX1 y .rsrc como pudimos comprobar con la herramienta CFF explorer con anterioridad.

Con la herramienta PE-bear confirmamos que las cadenas que encontramos con el comando string son las funciones de las librerías que usa esta muestra malware.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/lib2.JPG)

