### Muestra 3:


Para hacer el análisis estático básico vamos a usar una máquina con Remnux y una Windows7 donde tenemos instaladas las herramientas para el análisis. Para este típo de análisis es indiferente usar la versión de 64 o de 32 bits, ya que no vamos a ejecutar el malware, la versión solo es necesaria si las herramientas con las que vamos a analizarlo son para 32 o 64 bits. Partimos de la base de que tenemos una muestra y no sabemos que tipo de fichero es. Tenemos varias herramientas para ver que tipo de muestra es, yo he elegido el comando trid dado que estamos en linux:
- [**trid**](http://mark0.net/soft-trid-e.html): para reconocer el tipo de fichero que es. Es un fichero de windows ejecutable.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/trid.JPG)

#### Identificación

- Inicialmente tenemos que saber que **tipo de archivo** es. PE, DLL...
- Su **Hash**

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/hash.JPG)

Este hash podemos comprobarlo en webs como virus total para ver si ya existe algun report sobre ese archivo.

El **hash** también podemos usarlo para comparar diferentes muestras, si coinciden que tienen el mismo hash es porque se trata del mismo archivo.
En este caso, solo lo usaré para identificar la muestra.

- El **imphash**: se usa para identificar la familia a la que pertenece el malware. Si al comparar varios archivos vemos que tiene el mismo imphash significa que tiene la misma tabla de importaciones por lo que podemos pensar que son dos muestras parecidas.

- el **ssdeep**: nos ayuda a identificar dos muestras parecidas dando una puntuación en % de similitud entre ambas muestras.

Tanto el imphash como el ssdeep, identifican la familia a la que pertenece la muestra.

Podemos usar *Pescanner* para obtener el *hash*, el *imphash* y el *ssdeep*:

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/pescanner.JPG)

Aqui podemos ver la salida completa de pescanner:
```BASH
##########################################################################################
[0] File: muestra3.bin
##########################################################################################

Meta-data
==========================================================================================
Size		: 426496 bytes
Type		: PE32 executable (GUI) Intel 80386 (stripped to external PDB), for MS Windows
Architecture	: 32 Bits binary
MD5		: df95a6f88acf2af6401b2d349226be76
SHA1		: 63476f42c9b5ed22c8aeda3fd3187bec5b58b2ef
ssdeep		: 12288:o93XFVhy28HtOj3D27ohwRNd4powFRtkAtCy59kxlMtC:o93X53D2chuNd4RTx56xj
imphash		: 713c956e8cf57e6ac393cc1a275b72a1
Date		: 0x4BD0123A [Thu Apr 22 09:09:14 2010 UTC]
Language	: AFRIKAANS
CRC:	(Claimed) : 0x1f07e, (Actual): 0x6be69 [SUSPICIOUS]
Entry Point	: 0x401110 .text 0/6
================
Offset | Instructions
----------------------------------------
0	push ebp
1	mov ebp,esp
3	sub esp,0x14
6	push byte 0x2
8	call [0x4191d8]
14	call 0x401020
19	lea esi,[esi+0x0]
25	lea edi,[edi+0x0]
32	push ebp
33	mov ebp,esp
35	sub esp,0x14
38	push byte 0x1
40	call [0x4191d8]
46	call 0x401020
51	lea esi,[esi+0x0]
57	lea edi,[edi+0x0]
64	push ebp
65	mov ebp,esp
67	push ebx
68	sub esp,0x4
71	mov eax,[ebp+0x8]
74	mov eax,[eax]
76	mov eax,[eax]
78	cmp eax,0xc0000091
83	ja 0x4011a0
85	cmp eax,0xc000008d
90	jc 0x4011b7
92	mov ebx,0x1
97	push eax
98	push eax
99	push byte 0x0

Sections
==========================================================================================
Name       VirtAddr     VirtSize     RawSize    MD5                              Entropy
------------------------------------------------------------------------------------------
.text      0x1000       0xe470       0xe600     9acac2866eb354232b9acf4d3adc0a05 6.272105    
.data      0x10000      0x40e4       0x4200     4f04c7d256ce26eeb9f89aab709a1625 0.023279    [SUSPICIOUS]
.rdata     0x15000      0x27d0       0x2800     67e23eaecc44f4e6a4c2607b5b8e5dc4 5.231192    
.bss       0x18000      0xa4         0x0        d41d8cd98f00b204e9800998ecf8427e 0.000000    [SUSPICIOUS]
.idata     0x19000      0x690        0x800      607b262167f6b0bbed7e4b4c3e910201 4.191955    
.rsrc      0x1a000      0x525f0      0x52600    1227f58e72c0f4c35c58b257bda9483c 7.992449    [SUSPICIOUS]

Resource entries
==========================================================================================
Resource type      Total   
-------------------------
RT_ICON            : 3       
RT_RCDATA          : 2       
RT_GROUP_ICON      : 1       
------------------------------------------------------------------------------------------
Name               RVA      Size     Lang         Sublang                  Type
------------------------------------------------------------------------------------------
RT_ICON            0x1a178  0x1e8    LANG_AFRIKAANS SUBLANG_NEUTRAL          data
RT_ICON            0x1a360  0x6c8    LANG_AFRIKAANS SUBLANG_NEUTRAL          data
RT_ICON            0x1aa28  0x988    LANG_AFRIKAANS SUBLANG_NEUTRAL          data
RT_RCDATA          0x1b3b0  0x51200  LANG_NEUTRAL SUBLANG_NEUTRAL          data
RT_RCDATA          0x6c5b0  0xf      LANG_NEUTRAL SUBLANG_NEUTRAL          data
RT_GROUP_ICON      0x6c5c0  0x30     LANG_AFRIKAANS SUBLANG_NEUTRAL          MS Windows icon resource - 3 icons, 24x24, 16-colors

Imports
==========================================================================================
[1] KERNEL32.dll
	0x41914c CreateSemaphoreA
	0x419150 ExitProcess
	0x419154 FindResourceA
	0x419158 FreeResource
	0x41915c GetCommandLineA
	0x419160 GetCurrentThreadId
	0x419164 GetLastError
	0x419168 GetModuleFileNameA
	0x41916c GetModuleHandleA
	0x419170 GetProcAddress
	0x419174 GetStartupInfoA
	0x419178 GetVersionExA
	0x41917c InterlockedDecrement
	0x419180 InterlockedIncrement
	0x419184 LoadResource
	0x419188 LockResource
	0x41918c ReleaseSemaphore
	0x419190 SetLastError
	0x419194 SetUnhandledExceptionFilter
	0x419198 SizeofResource
	0x41919c Sleep
	0x4191a0 TlsAlloc
	0x4191a4 TlsFree
	0x4191a8 TlsGetValue
	0x4191ac TlsSetValue
	0x4191b0 WaitForSingleObject
	0x4191b4 lstrcpyA
[2] msvcrt.dll
	0x4191c0 _stat
[3] msvcrt.dll
	0x4191cc __getmainargs
	0x4191d0 __p__environ
	0x4191d4 __p__fmode
	0x4191d8 __set_app_type
	0x4191dc _cexit
	0x4191e0 _iob
	0x4191e4 _onexit
	0x4191e8 _setmode
	0x4191ec _strdup
	0x4191f0 abort
	0x4191f4 atexit
	0x4191f8 fputc
	0x4191fc fputs
	0x419200 free
	0x419204 fwrite
	0x419208 malloc
	0x41920c memchr
	0x419210 memcpy
	0x419214 memmove
	0x419218 memset
	0x41921c printf
	0x419220 realloc
	0x419224 signal
	0x419228 sprintf
	0x41922c strcat
	0x419230 strcmp
	0x419234 strcpy
	0x419238 strlen

Suspicious IAT alerts
==========================================================================================
[1] FindResourceA
[2] GetCommandLineA
[3] GetModuleFileNameA
[4] GetModuleHandleA
[5] GetProcAddress
[6] GetStartupInfoA
[7] GetVersionExA
[8] LockResource
[9] Sleep
```

- Comprobar si es .exe o .dll, si es .exe no esperaremos mucha info en la tabla de exportaciones y si es dll hay información en la tabla de importaciones. Tambien podemos comprobarlo directamente con la herramienta *Pestudio* en la sección file-headers si está habilitado el flag de *executable* o el flag de *dynamic-link-library*. Como vemos en la siguiente captura el fichero que tenemos entre manos es un ejecutable.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/Pestudio-m3-exe.JPG) 

#### Extraer indicadores

Para extraer indicadores miraremos las cadenas del fichero, se pueden usar diferentes herramientas. Por ejemplo el comando **strings** en linux, pero ya que tengo abierto **Pestudio** voy a ver las cadenas con esta herramienta. Aunque para generar un [fichero](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/strings-m3.txt) con las strings usare el comando string de la herramienta con el mismo nombre que tengo instalada en remnux.


![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/string.JPG) 

Las cadenas mas llamativas son las siguientes:
```BASH
!This program cannot be run in DOS mode.
.text
0`.data
.rdata
0@.bss
.idata
.rsrc
<.t*<_t&<$t\"
[^_]
[^_]
[^_]
[^_]
[^_]
<Gt\<TtX
<nt^1
<Et
<Eu
oper
ator
oper
ator
kdA
type
info
 nam
e fof
type
info
 fn 
for 
,dA
DdA
virt
ual 
thun
k to
java
 Cla
ss ff
vtab
le ff
VTT 
for 
type
info
 for
++C	
libgcj_s.dll
_Jv_RegisterClasses
unable to handle kernel paging request at address C0000010        Oops: 0002        EIP:   0010:XXXXXXXX        eax: xxxxxxxx   ebx: xxxxxxxx   ecx: xxxxxxxx   edx: xxxxxxxx        esi: xxxxxxxx   edi: xxxxxxxx   ebp: xxxxxxxx        ds: xxxx  es: xxxx  fs: xxxx  gs: xxxx        Pid: xx, process nr: xx        xx xx xx xx xx xx xx xx xx xx
OS2
%d,%d
Deutsch: L.n.R.: #200 Hakenkreuzfahne 30,00 
; #201 Kriegsfahne des Dritten Reiches 30,00 
; #204 SS-Totenkopf 30,00 
; #F-13 SS Heimwehr Danzig 30,00 
; #F-18 Kriegsministerium-Fahne 30,00 
. Bestellschein . Unser Angebot umfa
t viele Fahnen, Abzeichen, B
cher, CDs u.v.m.! Siehe mehr Fahnen!English: Left to Right: #200 Nazi Party Swastika Flags US$25.00; #201 qwuiw Reich Battle Flags US$25.00; #204 SS Death's Head Flags US$25.00; #F-13 SS Heimwehr Danzig Flags US$25.00; #F-18 War Ministry Flags US$25.00 - order form. We have many more Nazi flags - Hitler Youth flags, Prussian flags, German army flags, Luftwaffe flags, Kriegsmarine flags. See more Nazi flags! And more Nazi German militaria, Nazi Armbands, Nazi SS Rings
WHITEFUKINPOWER
THERE are some truths which are so obvious that for this very reason they are not seen or at least not recognized by ordinary people. They sometimes pass by such truisms as though blind and are most astonished when someone suddenly discovers what everyone really ought to know. Columbus\'s eggs lie around by the hundreds of thousands, but Columbuses are met with less frequently.Thus men without exception wander about in the garden of Nature; they imagine that they know practically everything and yet with few exceptions pass blindly by okkkwqdmwmkqdkmne of the most patent principles of Nature\'s rule: the inner segregation of the species of all living beings on this earth.Even the most superficial observation shows that Nature\'s restricted form of propagation and increase is an almost rigid basic law of all the innumerable forms of expression of       - A kernel with math-emulation compiled in will still use the          coprocessor if one is present: the math emulation will just          never get used in that case.  The kernel will be slightly larger,          but will work on different machines regardless of whether they          have a math coprocessor or not. her vital urge. Every animal mates only with a member of the same species. The titmouse seeks the titmouse, the finch the finch, the stork the stork, the field mouse the field mouse, the dormouse the dormouse, the wolf the she-wolf, etc.Only unusual circumstances can change this, primarily the compulsion of captivity or any other cause that makes it impossible tommkdqw mate within the same species. But then Nature begins to resist this with all possible means, and her most visible protest consists either in refusing further capacity for propagation to bastards or in limiting the fertility of later offspring; in most cases, however, she takes away the power of resistance to disease or hostile attacks.This is only too natural.
c:\dkmqkmkwd1
%u.%d.%d.%u.%d
5555DEIN Einsatz ist erst der Anfang! - YOUR action is just the beginning!
scumfagavs
/proc/blackbox
basic_string::_S_create
basic_string::at
basic_string::compare
basic_string::copy
basic_string::_S_construct NULL not valid
basic_string::basic_string
basic_string::substr
basic_string::assign
basic_string::_M_replace_aux
basic_string::replace
basic_string::insert
basic_string::erase
basic_string::append
basic_string::resize
Ns@
>s@
 s@
\'s@
6s@
 s@
std::exception
std::bad_exception
std::bad_cast
std::bad_typeid
__gnu_cxx::__concurrence_lock_error
__gnu_cxx::__concurrence_unlock_error
std::bad_alloc
terminate called recursively
terminate called after throwing an instance of \'
what()\:  
terminate called without an active exception
_GLOBAL_
(anonymous namespace)
<(@
global constructors keyed to 
global destructors keyed to 
std::allocator
allocator
std::basic_string
basic_string
std::string
std::basic_string<char, std::char_traits<char>, std::allocator<char> >
std::istream
std::basic_istream<char, std::char_traits<char> >
basic_istream
std::ostream
std::basic_ostream<char, std::char_traits<char> >
basic_ostream
std::iostream
std::basic_iostream<char, std::char_traits<char> >
basic_iostream
N10__cxxabiv117__class_type_infoE
N10__cxxabiv120__si_class_type_infoE
N10__cxxabiv121__vmi_class_type_infoE
N9__gnu_cxx24__concurrence_lock_errorE
N9__gnu_cxx26__concurrence_unlock_errorE
NSt8ios_base7failureE
St10bad_typeid
St11logic_error
St11range_error
St12domain_error
St12length_error
St12out_of_range
St13bad_exception
St13runtime_error
St14overflow_error
St15underflow_error
St16invalid_argument
St8bad_cast
St9bad_alloc
St9exception
St9type_info
CreateSemaphoreA
ExitProcess
FindResourceA
FreeResource
GetCommandLineA
GetCurrentThreadId
GetLastError
GetModuleFileNameA
GetModuleHandleA
GetProcAddress
GetStartupInfoA
GetVersionExA
InterlockedDecrement
InterlockedIncrement
LoadResource
LockResource
ReleaseSemaphore
SetLastError
SetUnhandledExceptionFilter
SizeofResource
Sleep
TlsAlloc
TlsFree
TlsGetValue
TlsSetValue
WaitForSingleObject
lstrcpyA
_stat
__getmainargs
__p__environ
__p__fmode
__set_app_type
_cexit
_iob
_onexit
_setmode
_strdup
abort
atexit
fputc
fputs
free
fwrite
malloc
memchr
memcpy
memmove
memset
printf
realloc
signal
sprintf
strcat
strcmp
strcpy
strlen
KERNEL32.dll
msvcrt.dll
msvcrt.dll
PADDINGXXPADDING
```

Podemos marcar algunas como más relevantes porque aparece el mensaje típico de los ficheros PE, los nombres de las secciones de un ejecutable .data .rdata .text .bss .idata .rsrc, diversos mensajes escritos parece que en aleman yn path c:\ ... varias funciones para comparar, copiar, insertar, borrar, redimensionar y reemplazar cadenas, las funciones de excepciones de la librería std de c++, diversos tipos de datos, aparecen llamadas a funciones de uso de semaforos busqueda de recursos, bloqueo de hebras, librerías como Kernel32.dll, msvcrt.dll, también aparece la palabra padding...

Deberíamos buscar lo siguiente, aunque algunas cosas las hemos encontrado en lo escrito en el párrafo anterior.

- Indicadores de host:  solo repercuten en la máquina
	- claves de registro
	- rutas de fichero
	- nombres de ficheros
- Indicadores de red:
	- rutas de dominio
	- protocolos que intenta usar para conectarse a un dominio concreto

Para sacar estos indicadores, podemos usar herramientas como **strings**, **floss**, **PEstudio** que además de ver las cadenas nos devuelven los nombres de las librerías.

#### Indicadores PE

Al abrir con la herramienta **CFF Explorer** vemos no parece que esté empaquetado. En la sección Section Headers nos aparecen las secciones *.text* *.data* *.rdata* *.bss* *idata* y *.rsrc*

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/cffheaders2.JPG) 

- Funciones API: filtrar las que considero por funcionalidad que tienen relación con la funcionalidad sospechosa del malware.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/lib.JPG) 

 Las librerías que aparecen son:
 Kernel32.dll - Librería que gestiona los procesos principales del Sistema, gestiona la memoria, los puertos de entrada salida.
 msvcrt.dll - usa funciones estandard de la librería de C, lo cual nos cuadra con el análisis ya que en las string encontramos muchas funciones propias de la librería de C para manipulación de cadenas.

- Busqueda de malformaciones: pueden hacernos sospechar empaquetamiento (tamaño en disco menor que el tamaño en memoria), ver que el entry point está dentro de la secion funciones, exportaciones (en caso de dll),  
- Busqueda de llamadas anónimas (funciones de la API sin nombre ni ordinal)

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/librerias.JPG)

Como podemos ver en CFFExplorer en la sección Dependency Walker no aparecen llamadas anónimas. 

- Recursos: si hay ficheros embebidos, binarios, shelcode, datos cifrados...

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/recursos.JPG)

Los recursos de este archivo no parecen importantes como para tenerlos en cuenta. Al menos con lo que vemos en el análisis estático. Habría que comprobarlo en el dinámico analizando esos recursos.

- Firmas: no contiene firmas.

- Entropia: de secciones y de recursos:

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/muestra3.JPG)

Nos fijamos en el % de tamaño de seccion y de recurso con respecto a la totalidad del fichero. PEstudio lo hace. El fichero tiene una entropia baja lo cual hace que sea sospechoso, siempre que este por debajo de 5 o por encima de 7, lo es.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/entropia.JPG)

- Secciones en las que no esperamos que aparezca el flag de escritura y sin embargo aparece (seccion .text con flag de escritura)
En PEstudio en Sections vemos que la sección .text tiene habilitado el flag de ejecutable y el entry point no es el que debería ser, eso es sospechoso.

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/secciones.JPG)

Con la herramienta Portex podemos sacar una imágen de colores que muestra gráficamente las secciones que tiene el archivo. 

![imagen](https://github.com/layoel/ExpertoAnalisisMalware/blob/master/AnalisisEstatico/muestra3/muestra3.jpg)

En la primera columna nos muestra que hay una zona en la que usa caracteres Ascii visibles, en la segunda columna podemos ver que hay una parte que hay código que está repetido. Y en la tercera vemos que la grán mayoria pertenece a la parte de recursos, así que tendremos que analizar esos recursos para ver porqué tienen que ocupar tanta parte del ejecutable.

Con el análisis estático no se muy bien lo que hace este malware pero si está claro que tiene cosas sospechosas que deberíamos analizar en dinámico y confirmar debugueando el código.

